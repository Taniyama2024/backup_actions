name: Daily Neon Backup

on:
  schedule:
    - cron: '0 15 * * *' # 毎日24時(JST)に実行（UTC 15:00）
  workflow_dispatch: # 手動実行も可

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Dump Neon database
        env:
          DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          pg_dump --no-owner --no-acl --format=custom --file=backup_$TIMESTAMP.dump "$DATABASE_URL"

      - name: Upload to Cloudflare R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        run: |
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          FILE=backup_$TIMESTAMP.dump
          aws configure set aws_access_key_id "$R2_ACCESS_KEY_ID"
          aws configure set aws_secret_access_key "$R2_SECRET_ACCESS_KEY"
          aws configure set default.region auto
          aws --endpoint-url "$R2_ENDPOINT" s3 cp "$FILE" s3://"$R2_BUCKET_NAME"/backups/"$FILE"

